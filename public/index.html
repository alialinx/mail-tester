<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mail Tester</title>

  <style>
    :root{
      --bg:#0b1020;
      --text:#e9ecf5;
      --muted:#a9b2cc;
      --border:rgba(255,255,255,.08);
      --ok:#2ecc71;
      --fail:#e74c3c;   /* missing */
      --unk:#95a5a6;
      --warn:#f1c40f;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(120,130,255,.15), transparent 60%),
        radial-gradient(900px 500px at 80% 10%, rgba(46,204,113,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .container{max-width:1100px;margin:40px auto;padding:0 16px}
    .header{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;margin-bottom:18px}
    .title{font-size:26px;font-weight:750;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.4}
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .grid{display:grid;grid-template-columns: 1.2fr .8fr;gap:14px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }

    label{display:block;font-size:12px;color:var(--muted);margin:6px 0 8px}
    input, textarea{
      width:100%;
      background: rgba(0,0,0,.18);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:12px;
      padding:12px;
      outline:none;
    }
    textarea{
      min-height:280px;
      resize:vertical;
      line-height:1.45;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12.5px;
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 520px){ .row{grid-template-columns:1fr} }
    .actions{display:flex;align-items:center;gap:10px;margin-top:12px;flex-wrap:wrap}
    button{
      border:0;
      border-radius:12px;
      padding:10px 14px;
      background: rgba(120,130,255,.18);
      color:var(--text);
      cursor:pointer;
      font-weight:650;
      letter-spacing:.2px;
      border:1px solid rgba(120,130,255,.25);
    }
    button.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
    }
    button:disabled{opacity:.55;cursor:not-allowed}
    .hint{color:var(--muted);font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .toast{
      margin-top:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background: rgba(0,0,0,.16);
      color: var(--muted);
      display:none;
    }
    .toast.show{display:block}

    /* Results */
    .results{margin-top:16px;display:none}
    .results.show{display:block}
    .cards{display:grid;grid-template-columns: repeat(12, 1fr);gap:12px}
    .card{
      grid-column: span 6;
      background: linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.20));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    @media (max-width: 920px){ .card{grid-column:span 12} }
    .card-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .card-title{font-weight:750;letter-spacing:.2px}
    .card-body{color:var(--muted);font-size:12.5px;line-height:1.45}

    .summary{
      grid-column: span 12;
      background: linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.18));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
    }
    .summary-top{
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      color: var(--text);
      font-weight: 700;
      font-size: 12px;
    }
    .score-pill{
      display:inline-flex;
      align-items:baseline;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(0,0,0,.14);
      border:1px solid var(--border);
    }
    .score-num{font-weight:900;font-size:18px;color:var(--text)}
    .score-den{color:var(--muted);font-size:12px}

    .issues{margin-top:10px}
    .issue{
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background: rgba(0,0,0,.14);
      margin-top:8px;
    }
    .issue-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .issue-title{font-weight:750;color:var(--text)}
    .issue-meta{color:var(--muted);font-size:12px}
    .issue-how{margin-top:6px;color:var(--muted)}
    .issue-code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 11.5px}

    /* Status icons */
    .status-icon{font-size:16px;cursor:help;user-select:none}
    .status-icon.ok{color:var(--ok)}
    .status-icon.missing{color:var(--fail)}
    .status-icon.unknown{color:var(--unk)}
    .status-icon.warning{color:var(--warn)}

    .kv{display:grid;grid-template-columns: 160px 1fr;gap:8px;margin-top:6px}
    .kv div:nth-child(odd){color:var(--muted)}
    .kv div:nth-child(even){color:var(--text)}
    .small{font-size:12px;color:var(--muted)}

    /* Message details (body) */
    .body-box{
      margin-top:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background: rgba(0,0,0,.14);
    }
    .body-title{font-weight:700;color:var(--text);margin-bottom:8px}
    .body-pre{
      white-space:pre-wrap;
      word-break:break-word;
      margin:0;
      font-size:12.5px;
      line-height:1.5;
      color:var(--text);
    }

    /* SpamAssassin */
    .sa-title{font-weight:750;margin:2px 0 6px;color:var(--text)}
    .sa-text{color:var(--muted);line-height:1.5}
    .sa-hint{
      margin-top: 8px;
      padding: 10px 12px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--muted);
      font-size: 12px;
    }
    .sa-rules{margin-top: 12px}
    .sa-rules-title{font-weight:700;color:var(--text);margin-bottom:8px}
    .sa-rule{
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background: rgba(0,0,0,.14);
      margin-bottom:8px;
    }
    .sa-rule-left{display:flex;gap:10px;align-items:baseline;margin-bottom:4px}
    .sa-rule-points{font-weight:800;min-width:42px;display:inline-block}
    .sa-rule-name{font-weight:700;color:var(--text)}
    .sa-rule-desc{color:var(--muted);font-size:12px;line-height:1.45}

    .footer-note{margin-top:14px;color:var(--muted);font-size:12px}
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="title">Mail Tester</div>
        <div class="subtitle">
          SPF / DKIM / DMARC / rDNS / Blacklist ve SpamAssassin kontrolleri.
          Sonuçlar sadece veri geldikten sonra açılır.
        </div>
      </div>
      <div class="badge">v1</div>
    </div>

    <div class="panel">
      <div class="grid">
        <div>
          <label for="rawEmail">Raw Email</label>
          <textarea id="rawEmail" class="mono" placeholder="E-postanın raw içeriğini buraya yapıştır..."></textarea>

          <div class="actions">
            <button id="btnAnalyze">Check</button>
            <button id="btnClear" class="secondary" type="button">Clear</button>
            <span id="loadingText" class="hint" style="display:none;">Kontrol ediliyor...</span>
          </div>

          <div id="toast" class="toast"></div>
        </div>

        <div>
          <div class="row">
            <div>
              <label for="domain">Domain</label>
              <input id="domain" placeholder="ör: example.com" />
              <div class="small">DKIM/DMARC/SPF kontrolleri bu domain üzerinden yapılır.</div>
            </div>
            <div>
              <label for="senderIp">Sender IP (opsiyonel)</label>
              <input id="senderIp" placeholder="ör: 1.2.3.4" />
              <div class="small">IP yoksa rDNS/blacklist “Unknown” görünür.</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <label for="apiUrl">API Endpoint</label>
            <input id="apiUrl" class="mono" value="/analyze" />
            <div class="small">Backend endpoint’in farklıysa burayı değiştir.</div>
          </div>

          <div class="footer-note">
            İpucu: “Check” basınca eski sonuçlar ekranda kalmaz; yeni sonuç gelince otomatik açılır.
          </div>
        </div>
      </div>
    </div>

    <div id="results" class="results">
      <div id="cards" class="cards"></div>
    </div>
  </div>

  <script>
    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function showToast(msg, kind = "info") {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      if (kind === "error") el.style.borderColor = "rgba(231,76,60,.35)";
      else el.style.borderColor = "rgba(255,255,255,.10)";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => el.classList.remove("show"), 3500);
    }

    function renderStatusIcon(status) {
      if (status === "ok") return `<span class="status-icon ok" title="Succeeded">✔</span>`;
      if (status === "missing") return `<span class="status-icon missing" title="Failed">✖</span>`;
      if (status === "warning") return `<span class="status-icon warning" title="Warning">⚠</span>`;
      return `<span class="status-icon unknown" title="Unknown">ℹ</span>`;
    }

    function prettyStatusLabel(status) {
      if (status === "ok") return "Succeeded";
      if (status === "missing") return "Failed";
      if (status === "warning") return "Warning";
      return "Unknown";
    }

    function safeArray(v) { return Array.isArray(v) ? v : []; }

    function formatScore(score, denom = 5) {
      const s = (typeof score === "number") ? score : 0;
      return `
        <div class="score-pill">
          <div class="score-num">${escapeHtml(s)}</div>
          <div class="score-den">/ ${escapeHtml(denom)}</div>
        </div>
      `;
    }

    function renderSummaryBlock(result) {
      const sum = result?.summary || {};
      const issues = safeArray(sum?.top_issues);
      const score = result?.score ?? sum?.score ?? 0;

      return `
        <div class="summary">
          <div class="summary-top">
            <div>
              <div class="badge">${escapeHtml(sum.grade || "Result")}</div>
              <div style="margin-top:10px;font-size:16px;font-weight:800;color:var(--text)">
                ${escapeHtml(sum.headline || "Deliverability summary")}
              </div>
              <div class="small" style="margin-top:6px">
                Bu özet, kontrollerin birleşik skoruna göre oluşturulur.
              </div>
            </div>
            ${formatScore(typeof score === "number" ? score : 0, 5)}
          </div>

          <div class="issues">
            ${issues.length ? issues.map(it => `
              <div class="issue">
                <div class="issue-top">
                  <div class="issue-title">${escapeHtml(it.title || it.message || "Issue")}</div>
                  <div class="issue-meta">
                    <span class="issue-code">${escapeHtml(it.code || "")}</span>
                    ${it.severity ? ` • ${escapeHtml(it.severity)}` : ""}
                    ${typeof it.points === "number" ? ` • ${escapeHtml(it.points)} pts` : ""}
                  </div>
                </div>
                ${it.how_to_fix ? `<div class="issue-how">${escapeHtml(it.how_to_fix)}</div>` : ""}
                ${it.details ? `<div class="issue-how"><span class="small">Details:</span> ${escapeHtml(it.details)}</div>` : ""}
              </div>
            `).join("") : `<div class="small">Öne çıkan problem yok.</div>`}
          </div>
        </div>
      `;
    }

    /* Meta + body (Message Details) */
    function renderMetaCard(meta) {
      const body = meta?.body; // backend'e ekledin
      const hasBody = !!(body && String(body).trim());

      return `
        <div class="card">
          <div class="card-head">
            <div class="card-title">Message Details</div>
            ${renderStatusIcon("ok")}
          </div>
          <div class="card-body">
            <div class="kv">
              <div>From</div><div class="mono">${escapeHtml(meta?.from || "")}</div>
              <div>To</div><div class="mono">${escapeHtml(meta?.to || "")}</div>
              <div>Subject</div><div class="mono">${escapeHtml(meta?.subject || "")}</div>
              <div>Message-ID</div><div class="mono">${escapeHtml(meta?.message_id || "")}</div>
              <div>Sender domain</div><div class="mono">${escapeHtml(meta?.sender_domain || "")}</div>
              <div>Sender IP</div><div class="mono">${escapeHtml(meta?.sender_ip || "")}</div>
            </div>

            <div class="body-box">
              <div class="body-title">Body</div>
              ${hasBody
                ? `<pre class="body-pre">${escapeHtml(body)}</pre>`
                : `<div class="small">Body bilgisi backend tarafından dönmedi (meta.body boş veya None).</div>`
              }
            </div>
          </div>
        </div>
      `;
    }

    function renderDnsCard(label, obj) {
      const status = obj?.status || (obj?.success === true ? "ok" : obj?.success === false ? "missing" : "unknown");
      const record = obj?.record;
      const recordText = Array.isArray(record)
        ? record.map(x => `<div class="mono">${escapeHtml(x)}</div>`).join("")
        : (record ? `<div class="mono">${escapeHtml(record)}</div>` : `<div class="small">Kayıt yok</div>`);

      return `
        <div class="card">
          <div class="card-head">
            <div class="card-title">${escapeHtml(label)}</div>
            ${renderStatusIcon(status)}
          </div>
          <div class="card-body">
            <div class="kv">
              <div>Status</div><div>${escapeHtml(prettyStatusLabel(status))}</div>
              <div>Domain</div><div class="mono">${escapeHtml(obj?.domain || "")}</div>
            </div>
            <div style="margin-top:10px">
              <div class="small">Record</div>
              <div style="margin-top:6px">${recordText}</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderHeadersCard(headers) {
      const status = headers?.status || "unknown";
      const missingReq = safeArray(headers?.missing_required);
      const missingRec = safeArray(headers?.missing_recommended);
      const raw = headers?.raw || {};

      return `
        <div class="card">
          <div class="card-head">
            <div class="card-title">Headers</div>
            ${renderStatusIcon(status === "ok" ? "ok" : "warning")}
          </div>
          <div class="card-body">
            <div class="kv">
              <div>From</div><div class="mono">${escapeHtml(raw.from || "")}</div>
              <div>To</div><div class="mono">${escapeHtml(raw.to || "")}</div>
              <div>Subject</div><div class="mono">${escapeHtml(raw.subject || "")}</div>
              <div>Date</div><div class="mono">${escapeHtml(raw.date || "")}</div>
              <div>Message-ID</div><div class="mono">${escapeHtml(raw.message_id || "")}</div>
            </div>

            ${missingReq.length ? `
              <div style="margin-top:10px">
                <div class="small">Missing (required)</div>
                <div style="margin-top:6px">${missingReq.map(x => `<div class="mono">${escapeHtml(x)}</div>`).join("")}</div>
              </div>
            ` : ""}

            ${missingRec.length ? `
              <div style="margin-top:10px">
                <div class="small">Missing (recommended)</div>
                <div style="margin-top:6px">${missingRec.map(x => `<div class="mono">${escapeHtml(x)}</div>`).join("")}</div>
              </div>
            ` : ""}
          </div>
        </div>
      `;
    }

    function renderSenderIpCard(senderIpObj) {
      const hasIp = !!senderIpObj?.value;
      const status = senderIpObj?.status || (hasIp ? "ok" : "missing");
      return `
        <div class="card">
          <div class="card-head">
            <div class="card-title">Sender IP</div>
            ${renderStatusIcon(status)}
          </div>
          <div class="card-body">
            <div class="kv">
              <div>Status</div><div>${escapeHtml(prettyStatusLabel(status))}</div>
              <div>IP</div><div class="mono">${escapeHtml(senderIpObj?.value || "")}</div>
            </div>
          </div>
        </div>
      `;
    }

    function renderRdnsCard(rdnsObj) {
      const status = rdnsObj?.status || (rdnsObj?.skipped ? "unknown" : (rdnsObj?.success ? "ok" : "missing"));
      const hostname = rdnsObj?.hostname ?? null;
      const skipped = !!rdnsObj?.skipped;

      return `
        <div class="card">
          <div class="card-head">
            <div class="card-title">rDNS</div>
            ${renderStatusIcon(status)}
          </div>
          <div class="card-body">
            <div class="kv">
              <div>Status</div><div>${escapeHtml(prettyStatusLabel(status))}</div>
              <div>Hostname</div><div class="mono">${escapeHtml(hostname || "")}</div>
              <div>Skipped</div><div>${escapeHtml(skipped ? "true" : "false")}</div>
            </div>
            ${status === "missing" ? `<div class="sa-hint">Reverse DNS eşleşmesi bulunamadı veya uyumsuz. IP reputasyonu/teslimat için rDNS önerilir.</div>` : ""}
          </div>
        </div>
      `;
    }

    function renderBlacklistCard(blObj) {
      const skipped = !!blObj?.skipped;
      const status = blObj?.status || (skipped ? "unknown" : "ok");

      const summary = blObj?.summary || {};
      const results = blObj?.results || {};

      const listed = Object.entries(results).filter(([k,v]) => v === "listed").map(([k]) => k);
      const timeouts = Object.entries(results).filter(([k,v]) => v === "timeout").map(([k]) => k);
      const errors = Object.entries(results).filter(([k,v]) => v === "error").map(([k]) => k);

      const showDetails = !skipped && (listed.length || timeouts.length || errors.length);

      return `
        <div class="card">
          <div class="card-head">
            <div class="card-title">Blacklists</div>
            ${renderStatusIcon(status)}
          </div>
          <div class="card-body">
            <div class="kv">
              <div>Status</div><div>${escapeHtml(prettyStatusLabel(status))}</div>
              <div>Checked</div><div>${escapeHtml(blObj?.checked ?? 0)}</div>
              <div>Listed</div><div>${escapeHtml(summary.listed ?? 0)}</div>
              <div>Not listed</div><div>${escapeHtml(summary.not_listed ?? 0)}</div>
              <div>Timeout</div><div>${escapeHtml(summary.timeout ?? 0)}</div>
              <div>Error</div><div>${escapeHtml(summary.error ?? 0)}</div>
            </div>

            ${showDetails ? `
              <div style="margin-top:10px">
                ${listed.length ? `
                  <div class="sa-hint">
                    <div style="font-weight:700;color:var(--text);margin-bottom:6px">Listed on</div>
                    ${listed.map(x => `<div class="mono">${escapeHtml(x)}</div>`).join("")}
                  </div>
                ` : ""}

                ${timeouts.length ? `
                  <div class="sa-hint" style="margin-top:8px">
                    <div style="font-weight:700;color:var(--text);margin-bottom:6px">Timeout</div>
                    ${timeouts.map(x => `<div class="mono">${escapeHtml(x)}</div>`).join("")}
                  </div>
                ` : ""}

                ${errors.length ? `
                  <div class="sa-hint" style="margin-top:8px">
                    <div style="font-weight:700;color:var(--text);margin-bottom:6px">Errors</div>
                    ${errors.map(x => `<div class="mono">${escapeHtml(x)}</div>`).join("")}
                  </div>
                ` : ""}
              </div>
            ` : (skipped ? `<div class="sa-hint">Sender IP olmadığı için blacklist kontrolü yapılmadı.</div>` : `<div class="small" style="margin-top:10px">Detay bulunmuyor.</div>`)}
          </div>
        </div>
      `;
    }

    function formatSaMessage(sa) {
      const score = (sa && typeof sa.score === "number") ? sa.score : null;
      const thr   = (sa && typeof sa.threshold === "number") ? sa.threshold : null;

      if (!sa || sa.status === "error") {
        return {
          status: "unknown",
          title: "SpamAssassin değerlendirmesi alınamadı",
          text: "SpamAssassin servisine erişilemediği için bu kontrol atlandı. Diğer kontroller sonuç vermeye devam eder.",
          hint: sa?.error ? `Hata: ${sa.error}` : null,
          showRules: false
        };
      }

      if (sa.is_spam === false) {
        return {
          status: "ok",
          title: "SpamAssassin mesajınızı olumlu değerlendirdi",
          text: `Mesaj, SpamAssassin kurallarına göre spam görünmüyor. Skorunuz ${score} / ${thr}.`,
          hint: "Bu iyi bir sinyal; inbox placement yine de SPF/DKIM/DMARC, itibar ve içerik faktörlerine bağlıdır.",
          showRules: true
        };
      }

      if (sa.is_spam === true) {
        return {
          status: "missing",
          title: "SpamAssassin mesajınızı riskli buldu",
          text: `Mesaj spam olarak işaretlenebilir. Skorunuz ${score} / ${thr}. İçeriği ve gönderim ayarlarını iyileştirmek faydalı olur.`,
          hint: "Aşağıdaki kurallar hangi noktaların risk oluşturduğunu gösterir.",
          showRules: true
        };
      }

      return {
        status: "unknown",
        title: "SpamAssassin sonucu net değil",
        text: "SpamAssassin yanıtı alındı ancak spam değerlendirmesi üretilemedi.",
        hint: null,
        showRules: false
      };
    }

    function renderSpamAssassinCard(sa) {
      const fm = formatSaMessage(sa);
      const rules = safeArray(sa?.rules);

      let rulesHtml = "";
      if (fm.showRules && rules.length > 0) {
        rulesHtml = `
          <div class="sa-rules">
            <div class="sa-rules-title">Detaylar</div>
            <div class="sa-rules-list">
              ${rules.map(r => `
                <div class="sa-rule">
                  <div class="sa-rule-left">
                    <span class="sa-rule-points">${escapeHtml(r.points)}</span>
                    <span class="sa-rule-name">${escapeHtml(r.name)}</span>
                  </div>
                  <div class="sa-rule-desc">${escapeHtml(r.description || "")}</div>
                </div>
              `).join("")}
            </div>
          </div>
        `;
      }

      return `
        <div class="card">
          <div class="card-head">
            <div class="card-title">SpamAssassin</div>
            ${renderStatusIcon(fm.status)}
          </div>
          <div class="card-body">
            <div class="sa-title">${escapeHtml(fm.title)}</div>
            <div class="sa-text">${escapeHtml(fm.text)}</div>
            ${fm.hint ? `<div class="sa-hint">${escapeHtml(fm.hint)}</div>` : ""}
          </div>
          ${rulesHtml}
        </div>
      `;
    }

    function renderAll(result) {
      const checks = result?.checks || {};

      const html = [
        renderSummaryBlock(result),
        renderMetaCard(result?.meta),           /* Message Details + Body */
        renderDnsCard("SPF", checks.spf),
        renderDnsCard("DKIM", checks.dkim),
        renderDnsCard("DMARC", checks.dmarc),
        renderHeadersCard(checks.headers),
        renderSenderIpCard(checks.sender_ip),
        renderRdnsCard(checks.rdns),
        renderBlacklistCard(checks.blacklists),
        renderSpamAssassinCard(checks.spamassassin),
      ].join("");

      document.getElementById("cards").innerHTML = html;
    }

    let lastRequestId = 0;

    async function doAnalyze() {
      const rawEmail = document.getElementById("rawEmail").value.trim();
      const domain = document.getElementById("domain").value.trim();
      const senderIp = document.getElementById("senderIp").value.trim();
      const apiUrl = document.getElementById("apiUrl").value.trim() || "/analyze";

      if (!rawEmail) { showToast("Raw email boş olamaz.", "error"); return; }
      if (!domain) { showToast("Domain boş olamaz.", "error"); return; }

      const resultsEl = document.getElementById("results");
      resultsEl.classList.remove("show");
      document.getElementById("cards").innerHTML = "";

      const btn = document.getElementById("btnAnalyze");
      const loadingText = document.getElementById("loadingText");
      btn.disabled = true;
      loadingText.style.display = "inline";

      const requestId = ++lastRequestId;

      try {
        const url = apiUrl.includes("?") ? `${apiUrl}&_ts=${Date.now()}` : `${apiUrl}?_ts=${Date.now()}`;
        const payload = { domain, sender_ip: senderIp || null, raw_email: rawEmail };

        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          cache: "no-store"
        });

        const data = await res.json().catch(() => null);
        if (requestId !== lastRequestId) return;

        if (!res.ok) {
          const msg = data?.error || data?.message || `HTTP ${res.status}`;
          showToast(`Hata: ${msg}`, "error");
          return;
        }
        if (!data) {
          showToast("Sunucudan geçersiz yanıt alındı.", "error");
          return;
        }

        renderAll(data);
        resultsEl.classList.add("show");
        showToast("Kontrol tamamlandı.");

      } catch (e) {
        if (requestId !== lastRequestId) return;
        showToast(`Bağlantı hatası: ${e}`, "error");
      } finally {
        if (requestId !== lastRequestId) return;
        btn.disabled = false;
        loadingText.style.display = "none";
      }
    }

    function clearAll() {
      document.getElementById("rawEmail").value = "";
      document.getElementById("domain").value = "";
      document.getElementById("senderIp").value = "";
      document.getElementById("results").classList.remove("show");
      document.getElementById("cards").innerHTML = "";
      showToast("Temizlendi.");
    }

    document.getElementById("btnAnalyze").addEventListener("click", doAnalyze);
    document.getElementById("btnClear").addEventListener("click", clearAll);

    document.getElementById("rawEmail").addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") doAnalyze();
    });
  </script>
</body>
</html>
