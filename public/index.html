<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mail Tester</title>
  <style>
    :root{
      --bg1:#f6f8ff;
      --bg2:#f7fbff;
      --card:#ffffffcc;
      --cardSolid:#fff;
      --text:#0b1220;
      --muted:#5b6b84;
      --border:#e6ebf4;
      --shadow: 0 18px 46px rgba(11,18,32,.10);
      --shadow2: 0 10px 26px rgba(11,18,32,.07);
      --r:16px;
      --r2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

      --primary:#2b59ff;
      --primary2:#2147d6;

      --good:#16a34a;
      --warn:#d97706;
      --bad:#dc2626;
      --neutral:#94a3b8;

      --goodBg:#f0fdf4;
      --warnBg:#fffbeb;
      --badBg:#fef2f2;

      --goodBd:#bbf7d0;
      --warnBd:#fde68a;
      --badBd:#fecaca;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 35% -10%, rgba(43,89,255,.18), transparent 58%),
        radial-gradient(900px 560px at 92% 10%, rgba(22,163,74,.08), transparent 58%),
        radial-gradient(900px 560px at 8% 20%, rgba(217,119,6,.06), transparent 58%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:34px 16px 70px;
    }
    .header{
      display:flex;
      align-items:flex-start;
      gap:14px;
      justify-content:center;
      margin-bottom:18px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(180deg,var(--primary),var(--primary2));
      display:grid;place-items:center;color:#fff;
      box-shadow:0 14px 30px rgba(43,89,255,.22);
      flex:0 0 auto;
    }
    .titleBlock{
      max-width:760px;
    }
    h1{
      margin:0;
      font-size:20px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .sub{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }

    .card{
      background:var(--card);
      backdrop-filter: blur(10px);
      border:1px solid rgba(230,235,244,.95);
      border-radius:var(--r2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHd{
      padding:14px 16px;
      border-bottom:1px solid rgba(230,235,244,.95);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:rgba(255,255,255,.65);
    }
    .cardHd .t{
      font-weight:950;
      font-size:14px;
    }
    .cardHd .s{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .cardBd{ padding:16px; }

    .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:center;
    }
    @media (max-width:840px){
      .row{ grid-template-columns:1fr; }
    }
    .input{
      width:100%;
      border:1px solid var(--border);
      background:#fff;
      border-radius:16px;
      padding:13px 14px;
      font-size:14px;
      font-family:var(--mono);
      outline:none;
      box-shadow:0 12px 26px rgba(11,18,32,.06);
    }
    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      border-radius:16px;
      padding:11px 13px;
      font-weight:950;
      cursor:pointer;
      transition: transform .06s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .btn:hover{
      box-shadow:0 14px 30px rgba(11,18,32,.10);
      border-color:#d7dfef;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background:linear-gradient(180deg,var(--primary),var(--primary2));
      border-color:transparent;
      color:#fff;
    }
    .btn.primary:disabled{
      opacity:.55; cursor:not-allowed; box-shadow:none;
    }

    .statusLine{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .statusLeft{
      display:flex; align-items:center; gap:10px;
      color:var(--muted);
      font-size:13px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:#cbd5e1;
    }
    .dot.good{ background:var(--good); }
    .dot.warn{ background:var(--warn); }
    .dot.bad{ background:var(--bad); }

    .progressWrap{
      display:none;
      align-items:center;
      gap:10px;
      min-width:260px;
    }
    .spinner{
      width:14px;height:14px;border-radius:999px;
      border:2px solid rgba(43,89,255,.25);
      border-top-color: rgba(43,89,255,1);
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }
    .bar{
      flex:1 1 auto;
      height:8px;
      border-radius:999px;
      background:#e9efff;
      overflow:hidden;
      border:1px solid #dbe4ff;
    }
    .bar > i{
      display:block;
      height:100%;
      width:40%;
      background:linear-gradient(90deg,var(--primary),rgba(43,89,255,.45));
      animation: slide 1.0s ease-in-out infinite;
    }
    @keyframes slide{
      0%{ transform: translateX(-120%); }
      100%{ transform: translateX(280%); }
    }

    /* REPORT WRAP: IMPORTANT - hidden until analyzed/error/expired */
    #reportWrap{
      display:none; /* This guarantees "Check" won't open it unless JS sets block */
      margin-top:14px;
    }

    /* Score summary card */
    .scoreCard{
      border:1px solid var(--border);
      border-radius:18px;
      background:#fff;
      padding:14px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .scoreCard.good{ border-color:var(--goodBd); background:var(--goodBg); }
    .scoreCard.warn{ border-color:var(--warnBd); background:var(--warnBg); }
    .scoreCard.bad{ border-color:var(--badBd); background:var(--badBg); }
    .scoreCard.neutral{ border-color:var(--border); background:#fff; }

    .scoreLeft{
      display:flex; align-items:center; gap:12px; min-width:0;
    }
    .scoreBox{
      width:70px; height:70px; border-radius:18px;
      background:#fff;
      border:1px solid var(--border);
      display:grid; place-items:center;
      text-align:center;
    }
    .scoreN{ font-weight:950; font-size:20px; line-height:1; }
    .scoreSub{ font-size:11px; color:var(--muted); margin-top:4px; }
    .scoreText .title{ font-weight:950; font-size:16px; margin:0; }
    .scoreText .desc{ color:var(--muted); font-size:13px; margin-top:4px; line-height:1.45; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      font-size:12px;
      font-weight:950;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill.good{ color:#166534; border-color:var(--goodBd); background:var(--goodBg); }
    .pill.warn{ color:#92400e; border-color:var(--warnBd); background:var(--warnBg); }
    .pill.bad{ color:#991b1b; border-color:var(--badBd); background:var(--badBg); }
    .pill.neutral{ color:#475569; border-color:#e2e8f0; background:#f8fafc; }

    .legend{
      font-size:12px;
      color:var(--muted);
      background:#fff;
      border:1px solid var(--border);
      padding:8px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    /* Sections (accordion) */
    details{
      border:1px solid var(--border);
      background:#fff;
      border-radius:18px;
      padding:12px;
    }
    summary{
      cursor:pointer;
      font-weight:950;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    summary::-webkit-details-marker{ display:none; }
    .sumRight{
      display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px;
    }
    .chev{
      width:22px;height:22px;border-radius:10px;
      border:1px solid var(--border);
      background:#f8fafc;
      display:grid;place-items:center;
      color:var(--muted);
      font-family:var(--mono);
      font-size:12px;
      flex:0 0 auto;
    }
    details[open] .chev{ transform: rotate(90deg); }
    .sectionBody{
      margin-top:10px;
      color:var(--text);
    }

    /* Issues */
    .issueHead{
      display:flex; align-items:center; justify-content:space-between;
      margin:4px 2px 10px;
      gap:10px;
    }
    .issueHead h3{
      margin:0; font-size:14px;
    }
    .issueCount{ font-size:12px; color:var(--muted); }
    .issues{ display:flex; flex-direction:column; gap:10px; }
    .issueRow{
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      padding:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:start;
    }
    .issueTitle{ font-weight:950; }
    .issueMeta{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }
    .issueFix{
      margin-top:8px;
      font-size:13px;
      line-height:1.5;
    }
    .issueDelta{
      border:1px solid var(--border);
      background:#f8fafc;
      color:var(--muted);
      border-radius:999px;
      padding:6px 10px;
      height:fit-content;
      font-family:var(--mono);
      font-size:12px;
      font-weight:950;
      min-width:70px;
      text-align:center;
      white-space:nowrap;
    }
    .mono{ font-family:var(--mono); }

    .emptyState{
      border:1px dashed var(--border);
      border-radius:16px;
      padding:12px;
      color:var(--muted);
      background:#fff;
      font-size:13px;
      line-height:1.55;
    }

    /* Checks table */
    .checkRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:10px 10px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      margin-bottom:10px;
    }
    .checkName{ font-weight:950; font-size:13px; }
    .checkHint{ margin-top:4px; font-size:12px; color:var(--muted); line-height:1.45; }

    /* DNSBL chips list */
    .dnsSection{ margin-top:10px; }
    .dnsTitle{
      display:flex; align-items:center; gap:8px;
      font-weight:950; font-size:13px;
      margin-bottom:8px;
    }
    .dnsCount{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      background:#f8fafc;
      border-radius:999px;
      padding:3px 8px;
      font-weight:950;
    }
    .dnsList{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .dnsItem{
      font-family:var(--mono);
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      color:var(--muted);
    }
    .dnsItem.good{ border-color:var(--goodBd); background:var(--goodBg); color:#166534; }
    .dnsItem.bad{ border-color:var(--badBd); background:var(--badBg); color:#991b1b; }
    .dnsItem.warn{ border-color:var(--warnBd); background:var(--warnBg); color:#92400e; }

    .code{
      white-space:pre-wrap;
      font-family:var(--mono);
      background:#0b1220;
      color:#e5e7eb;
      border:1px solid #111827;
      border-radius:16px;
      padding:12px;
      overflow:auto;
      max-height:380px;
    }

    /* Small footer note */
    .note{
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="logo" aria-hidden="true">
        <!-- simple envelope -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M4 7.5A2.5 2.5 0 0 1 6.5 5h11A2.5 2.5 0 0 1 20 7.5v9A2.5 2.5 0 0 1 17.5 19h-11A2.5 2.5 0 0 1 4 16.5v-9Z" stroke="white" stroke-width="2"/>
          <path d="M6.5 8l5.5 4 5.5-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="titleBlock">
        <h1>Mail Tester</h1>
        <div class="sub">
          Step 1: Send your email to the generated test address.<br/>
          Step 2: Click <b>Check score</b> to get a deliverability report (headers, authentication, reputation, and SpamAssassin signals).
        </div>
      </div>
    </div>

    <div class="card">
      <div class="cardHd">
        <div class="t">Test address</div>
        <div class="s" id="rightStatus">Status: —</div>
      </div>
      <div class="cardBd">
        <div class="row">
          <input id="toAddress" class="input" readonly placeholder="Generating..."/>
          <div class="btns">
            <button id="btnCopy" class="btn">Copy</button>
            <button id="btnCheck" class="btn primary" disabled>Check score</button>
            <button id="btnRegen" class="btn">Regenerate</button>
          </div>
        </div>

        <div class="statusLine">
          <div class="statusLeft">
            <span id="dot" class="dot warn"></span>
            <span id="statusText">Generating address…</span>
          </div>

          <div id="progressWrap" class="progressWrap" aria-hidden="true">
            <span class="spinner"></span>
            <span class="bar"><i></i></span>
          </div>
        </div>

        <!-- REPORT (hidden until results are final) -->
        <div id="reportWrap">
          <div class="scoreCard neutral" id="scoreCard" style="margin-top:12px;">
            <div class="scoreLeft">
              <div class="scoreBox">
                <div>
                  <div class="scoreN" id="scoreNum">—</div>
                  <div class="scoreSub">/ 10</div>
                </div>
              </div>
              <div class="scoreText">
                <div class="title" id="gradeText">—</div>
                <div class="desc" id="summaryText">—</div>
              </div>
            </div>

            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
              <span class="legend">Legend: ≥ 8 green • 6–7.9 yellow • &lt; 6 red</span>
              <span class="pill neutral" id="pillStatus">status</span>
              <span class="pill neutral" id="pillSA">SpamAssassin: n/a</span>
            </div>
          </div>

          <div style="margin-top:12px;">
            <div class="issueHead">
              <h3>Issues (actionable fixes first)</h3>
              <div class="issueCount"><span id="issueCount">0</span></div>
            </div>
            <div id="issues" class="issues"></div>
          </div>

          <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
            <details open>
              <summary>
                <span>SpamAssassin</span>
                <span class="sumRight">
                  <span class="pill neutral" id="saHeadline">—</span>
                  <span class="chev">›</span>
                </span>
              </summary>
              <div class="sectionBody">
                <div class="note" style="margin-bottom:10px;">
                  SpamAssassin assigns a score based on rules. If the score meets or exceeds the threshold, it is considered spam.
                  This is a useful signal, but inbox placement also depends on authentication, reputation, and engagement.
                </div>
                <div class="code" id="saReport">(no report)</div>
              </div>
            </details>

            <details open>
              <summary>
                <span>Authentication & header checks</span>
                <span class="sumRight">
                  <span style="color:var(--muted);font-size:12px;">SPF / DKIM / DMARC / rDNS</span>
                  <span class="chev">›</span>
                </span>
              </summary>
              <div class="sectionBody" id="checksBody"></div>
            </details>

            <details open>
              <summary>
                <span>DNSBL / blocklists</span>
                <span class="sumRight">
                  <span style="color:var(--muted);font-size:12px;">Listed in red • Not listed in green</span>
                  <span class="chev">›</span>
                </span>
              </summary>
              <div class="sectionBody" id="dnsblBody"></div>
            </details>
          </div>
        </div>

      </div>
    </div>

  </div>

<script>
  // ---------- State ----------
  let API_BASE = `${location.origin}/api`;
  let currentTo = null;

  // Prevent stale results after regenerate
  let runId = 0;

  // Polling / cancel
  let pollTimer = null;
  let activeAbort = null;

  // ---------- DOM helpers ----------
  const $ = (id) => document.getElementById(id);

  const safeJson = (o) => {
    try { return JSON.stringify(o, null, 2); } catch { return String(o); }
  };

  function setStatus(text, kind = "warn") {
    $("statusText").textContent = text;
    $("dot").className = "dot " + (kind || "");
  }

  function setRightStatus(st) {
    $("rightStatus").textContent = `Status: ${st || "—"}`;
  }

  function showProgress(on) {
    $("progressWrap").style.display = on ? "flex" : "none";
  }

  function stopPolling() {
    if (pollTimer) {
      clearInterval(pollTimer);
      pollTimer = null;
    }
  }

  function cancelInFlight() {
    try { activeAbort?.abort(); } catch {}
    activeAbort = null;
  }

  // IMPORTANT: keep report hidden until final
  function hideReport() {
    $("reportWrap").style.display = "none";
  }
  function showReport() {
    $("reportWrap").style.display = "block";
  }

  // ---------- API ----------
  async function apiGenerate(signal) {
    const res = await fetch(`${API_BASE}/generate`, { method: "POST", signal });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(`Generate failed: ${res.status}`);

    const addr =
      data.to_address ||
      data.toAddress ||
      data.address ||
      data.email ||
      data.test_address ||
      (typeof data.result === "string" ? data.result : null) ||
      data.result?.to_address ||
      data.result?.address ||
      data.result?.email;

    if (!addr) throw new Error("Generate response did not include address. Raw: " + safeJson(data));
    return addr;
  }

  async function apiResult(toAddr, signal) {
    const encoded = encodeURIComponent(toAddr);
    const res = await fetch(`${API_BASE}/result/${encoded}`, { signal });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(`Result failed: ${res.status}`);
    return data;
  }

  // ---------- Score colors ----------
  function scoreBand(score) {
    const s = Number(score);
    if (!isFinite(s)) return "neutral";
    if (s >= 8) return "good";
    if (s >= 6) return "warn";
    return "bad";
  }

  // ---------- SpamAssassin parsing / formatting ----------
  function parseSaFromReport(reportText) {
    const t = String(reportText || "");
    const m = t.match(/Spam:\s*(True|False)\s*;\s*([-\d.]+)\s*\/\s*([-\d.]+)/i);
    if (!m) return null;
    return {
      isSpam: m[1].toLowerCase() === "true",
      score: Number(m[2]),
      threshold: Number(m[3]),
    };
  }

  function formatSaScore(score) {
    const n = Number(score);
    if (!isFinite(n)) return "—";
    // You requested: do NOT show negative score; show absolute value instead
    return `${Math.abs(n).toFixed(1)}`;
  }

  // ---------- Issues helpers ----------
  function fixSuggestion(issueText) {
    const t = (issueText || "").toLowerCase();
    if (t.includes("list-unsubscribe")) return "Add a List-Unsubscribe header (mailto: and/or https) for bulk mail.";
    if (t.includes("spf")) return "Publish an SPF record (v=spf1 ...) that authorizes your sending IP/provider.";
    if (t.includes("dkim")) return "Enable DKIM signing for your domain and publish the selector TXT record.";
    if (t.includes("dmarc")) return "Add a DMARC policy at _dmarc (start with p=none, then enforce).";
    if (t.includes("reverse") || t.includes("rdns")) return "Set PTR (reverse DNS) to match your HELO / sending domain.";
    if (t.includes("blacklist") || t.includes("dnsbl")) return "Investigate the listing, fix the root cause, and request delisting.";
    if (t.includes("message-id")) return "Ensure your mail server generates a valid Message-ID header.";
    if (t.includes("date header")) return "Ensure your mail includes a Date header (RFC 5322).";
    return "Review email headers and authentication for this item.";
  }

  function impactLabel(value) {
    const v = Number(value || 0);
    if (v >= 2) return "High";
    if (v >= 0.8) return "Medium";
    return "Low";
  }

  // ---------- Render ----------
  function renderTopSummary(status, result) {
    const score = (typeof result.score === "number") ? result.score : Number(result.score || 0);

    $("scoreNum").textContent = isFinite(score) ? score.toFixed(1) : "—";
    $("gradeText").textContent = result.title || "—";

    const band = scoreBand(score);
    $("scoreCard").classList.remove("good","warn","bad","neutral");
    $("scoreCard").classList.add(band);

    const issueCount = Array.isArray(result.items) ? result.items.length : 0;
    const best = score >= 9.5 ? "Excellent" : (score >= 8 ? "Good" : (score >= 6 ? "Needs work" : "Poor"));

    $("summaryText").textContent =
      issueCount === 0
        ? `${best}. No major deliverability issues detected.`
        : `${best}. Found ${issueCount} issue(s). Fix the items below to improve inbox placement.`;

    // Status pill
    $("pillStatus").textContent = status || "unknown";
    $("pillStatus").classList.remove("good","warn","bad","neutral");
    $("pillStatus").classList.add(
      status === "analyzed" ? "good" :
      (status === "processing" || status === "pending") ? "warn" :
      (status === "error" || status === "expired") ? "bad" : "neutral"
    );

    // SpamAssassin pill (user-friendly)
    const sa = result.spamassassin || null;
    let saText = "SpamAssassin: n/a";
    let saKind = "neutral";

    if (sa?.report) {
      const parsed = parseSaFromReport(sa.report);
      if (parsed) {
        if (parsed.isSpam) {
          saKind = "bad";
          saText = `SpamAssassin: Spam (${formatSaScore(parsed.score)} / ${Math.abs(parsed.threshold).toFixed(1)})`;
        } else {
          saKind = "good";
          saText = `SpamAssassin: Not spam (${formatSaScore(parsed.score)} / ${Math.abs(parsed.threshold).toFixed(1)})`;
        }
      } else {
        saKind = "neutral";
        saText = "SpamAssassin: OK";
      }
    } else if (sa?.error) {
      saKind = "warn";
      saText = "SpamAssassin: error";
    }

    $("pillSA").textContent = saText;
    $("pillSA").classList.remove("good","warn","bad","neutral");
    $("pillSA").classList.add(saKind);
  }

  function renderIssues(result) {
    const host = $("issues");
    host.innerHTML = "";

    const items = Array.isArray(result.items) ? result.items : [];
    $("issueCount").textContent = `${items.length} issue(s)`;

    if (items.length === 0) {
      const ok = document.createElement("div");
      ok.className = "emptyState";
      ok.innerHTML = "<b>No issues detected.</b> Your email looks good for deliverability.";
      host.appendChild(ok);
      return;
    }

    const sorted = items.slice().sort((a, b) => (Number(b.value || 0) - Number(a.value || 0)));

    for (const it of sorted) {
      const what = it.text || it.title || "Issue";
      const val = Number(it.value ?? 0);
      const impact = impactLabel(val);
      const fix = fixSuggestion(what);

      const el = document.createElement("div");
      el.className = "issueRow";
      el.innerHTML = `
        <div>
          <div class="issueTitle">${what}</div>
          <div class="issueMeta"><b>Impact:</b> ${impact} · <span class="mono">-${val.toFixed(1)}</span> points</div>
          <div class="issueFix"><b>Fix:</b> ${fix}</div>
        </div>
        <div class="issueDelta">-${val.toFixed(1)}</div>
      `;
      host.appendChild(el);
    }
  }

  function verdictFromObj(obj) {
    if (obj == null) return { kind: "neutral", text: "Unknown" };
    if (typeof obj === "boolean") return obj ? { kind: "good", text: "Pass" } : { kind: "bad", text: "Fail" };
    if (typeof obj === "string") {
      const t = obj.toLowerCase().trim();
      if (["pass","ok","true","exists","found","present","yes"].includes(t)) return { kind: "good", text: "Pass" };
      if (["fail","false","missing","not_found","no"].includes(t)) return { kind: "bad", text: "Fail" };
      if (["skipped"].includes(t)) return { kind: "neutral", text: "Skipped" };
      return { kind: "neutral", text: obj };
    }
    if (obj.skipped === true) return { kind: "neutral", text: "Skipped" };
    const candidates = [obj.pass, obj.ok, obj.success, obj.exists, obj.found];
    for (const c of candidates) {
      if (c === true || String(c).toLowerCase() === "true") return { kind: "good", text: "Pass" };
      if (c === false || String(c).toLowerCase() === "false") return { kind: "bad", text: "Fail" };
    }
    return { kind: "neutral", text: "Unknown" };
  }

  function renderChecks(result) {
    const host = $("checksBody");
    host.innerHTML = "";

    const checks = result.checks || {};
    const rows = [
      { name:"SPF",   hint:"TXT record v=spf1", verdict: verdictFromObj(checks.spf) },
      { name:"DKIM",  hint:"DomainKey signature + selector", verdict: verdictFromObj(checks.dkim) },
      { name:"DMARC", hint:"_dmarc policy record", verdict: verdictFromObj(checks.dmarc) },
      { name:"rDNS",  hint:"PTR / reverse DNS", verdict: verdictFromObj(checks.rdns) },
    ];

    if (rows.length === 0) {
      host.innerHTML = `<div class="emptyState">(no checks)</div>`;
      return;
    }

    for (const r of rows) {
      const div = document.createElement("div");
      div.className = "checkRow";
      div.innerHTML = `
        <div>
          <div class="checkName">${r.name}</div>
          <div class="checkHint">${r.hint}</div>
        </div>
        <span class="pill ${r.verdict.kind}">${r.verdict.text}</span>
      `;
      host.appendChild(div);
    }
  }

  function renderDNSBL(result) {
    const host = $("dnsblBody");
    host.innerHTML = "";

    const checks = result.checks || {};
    const bl = checks.blacklists || checks.dnsbl || null;
    const res = bl?.results || null;

    if (!res || typeof res !== "object" || Object.keys(res).length === 0) {
      host.innerHTML = `<div class="emptyState">(no DNSBL details)</div>`;
      return;
    }

    const listed = [];
    const notListed = [];
    const timeout = [];
    const err = [];

    for (const [name, st] of Object.entries(res)) {
      if (st === "listed") listed.push(name);
      else if (st === "not_listed") notListed.push(name);
      else if (st === "timeout") timeout.push(name);
      else err.push(name);
    }

    function section(title, arr, kind) {
      return `
        <div class="dnsSection">
          <div class="dnsTitle">${title} <span class="dnsCount">${arr.length}</span></div>
          <div class="dnsList">
            ${arr.map(x => `<span class="dnsItem ${kind}">${x}</span>`).join("")}
          </div>
        </div>
      `;
    }

    // Your requirement: only show timeout/errors if there are any
    const parts = [];
    if (listed.length) parts.push(section("Listed on", listed, "bad"));
    if (notListed.length) parts.push(section("Not listed on", notListed, "good"));
    if (timeout.length) parts.push(section("Timeout", timeout, "warn"));
    if (err.length) parts.push(section("Other errors", err, "warn"));

    host.innerHTML = parts.join("") || `<div class="emptyState">(no DNSBL results)</div>`;
  }

  function renderSpamAssassin(result) {
    const sa = result.spamassassin || {};
    const report = (sa.report || "").trim();
    $("saReport").textContent = report ? report : "(no report)";

    let headlineText = "—";
    let headlineKind = "neutral";

    if (report) {
      const parsed = parseSaFromReport(report);
      if (parsed) {
        if (parsed.isSpam) {
          headlineKind = "bad";
          headlineText = `Spam · ${formatSaScore(parsed.score)} / ${Math.abs(parsed.threshold).toFixed(1)}`;
        } else {
          // IMPORTANT: do not show negative score; also avoid confusing "-1"
          headlineKind = "good";
          headlineText = `Not spam · ${formatSaScore(parsed.score)} / ${Math.abs(parsed.threshold).toFixed(1)}`;
        }
      } else {
        headlineKind = "neutral";
        headlineText = "Report available";
      }
    } else if (sa.error) {
      headlineKind = "warn";
      headlineText = `Error: ${sa.error}`;
    }

    $("saHeadline").textContent = headlineText;
    $("saHeadline").classList.remove("good","warn","bad","neutral");
    $("saHeadline").classList.add(headlineKind);
  }

  function renderAll(payload) {
    const status = payload?.status || "unknown";
    const result = payload?.result || {};

    renderTopSummary(status, result);
    renderIssues(result);
    renderSpamAssassin(result);
    renderChecks(result);
    renderDNSBL(result);
  }

  // ---------- Polling ----------
  async function refreshOnce(localRunId) {
    // Guard stale runs
    if (localRunId !== runId) return;

    const to = currentTo;
    const signal = activeAbort?.signal;

    const payload = await apiResult(to, signal);

    // Guard again after await
    if (localRunId !== runId) return;
    if (to !== currentTo) return;

    const st = payload?.status || "unknown";
    setRightStatus(st);

    // FINAL states: only here we show report
    if (st === "analyzed" || st === "error" || st === "expired") {
      showProgress(false);

      // Now show report and render
      showReport();
      renderAll(payload);

      if (st === "analyzed") setStatus("Analyzed. Showing results.", "good");
      else setStatus(`Finished with status: ${st}`, "bad");

      stopPolling();
      $("btnCheck").disabled = false;
      $("btnCheck").textContent = "Check score";
      return;
    }

    // WAITING states: keep report hidden
    hideReport();
    showProgress(true);
    setStatus(`Waiting… (${st})`, "warn");
  }

  function startPolling(localRunId) {
    stopPolling();
    pollTimer = setInterval(async () => {
      try {
        await refreshOnce(localRunId);
      } catch (e) {
        if (localRunId !== runId) return; // ignore stale errors
        stopPolling();
        showProgress(false);
        hideReport();
        setStatus("Error: " + (e?.message || e), "bad");
        $("btnCheck").disabled = false;
        $("btnCheck").textContent = "Check score";
      }
    }, 2500);
  }

  // ---------- Actions ----------
  async function generateAddress() {
    runId += 1;
    const localRunId = runId;

    stopPolling();
    cancelInFlight();
    activeAbort = new AbortController();

    // Reset UI
    hideReport();
    showProgress(false);

    $("toAddress").value = "";
    $("btnCheck").disabled = true;
    $("btnCheck").textContent = "Check score";
    currentTo = null;

    setStatus("Generating address…", "warn");
    setRightStatus("—");

    const addr = await apiGenerate(activeAbort.signal);
    if (localRunId !== runId) return;

    currentTo = addr;
    $("toAddress").value = addr;

    setStatus("Address ready. Send your email, then click Check score.", "good");
    setRightStatus("pending");
    $("btnCheck").disabled = false;
  }

  $("btnCopy").addEventListener("click", async () => {
    const v = $("toAddress").value;
    if (!v) return;
    try {
      await navigator.clipboard.writeText(v);
      setStatus("Copied to clipboard.", "good");
      setTimeout(() => {
        if (currentTo) setStatus("Address ready. Send your email, then click Check score.", "good");
      }, 900);
    } catch {
      $("toAddress").select();
      document.execCommand("copy");
      setStatus("Copied.", "good");
      setTimeout(() => {
        if (currentTo) setStatus("Address ready. Send your email, then click Check score.", "good");
      }, 900);
    }
  });

  $("btnCheck").addEventListener("click", async () => {
    if (!currentTo) return;

    // KEY: do NOT open report area when checking
    hideReport();

    const localRunId = runId;

    try {
      cancelInFlight();
      activeAbort = new AbortController();

      $("btnCheck").disabled = true;
      $("btnCheck").textContent = "Checking…";

      setStatus("Checking for results…", "warn");
      showProgress(true);

      await refreshOnce(localRunId);
      startPolling(localRunId);
    } catch (e) {
      if (localRunId !== runId) return;
      showProgress(false);
      hideReport();
      setStatus("Error: " + (e?.message || e), "bad");
      $("btnCheck").disabled = false;
      $("btnCheck").textContent = "Check score";
    }
  });

  $("btnRegen").addEventListener("click", async () => {
    try {
      await generateAddress();
    } catch (e) {
      showProgress(false);
      hideReport();
      setStatus("Error: " + (e?.message || e), "bad");
    }
  });

  // Init
  (function init() {
    // Hard guarantee: hidden on first load
    hideReport();
    showProgress(false);
    setRightStatus("—");
    generateAddress().catch(e => {
      setStatus("Error: " + (e?.message || e), "bad");
    });
  })();
</script>
</body>
</html>
