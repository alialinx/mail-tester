<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mail Tester</title>
  <style>
    :root{
      --bg:#f7f8fb;
      --panel:#ffffff;
      --text:#0b1220;
      --muted:#58657b;
      --border:#e7ebf3;

      --primary:#2563eb;
      --primary2:#1d4ed8;

      --good:#16a34a;
      --warn:#d97706;
      --bad:#dc2626;

      --shadow: 0 18px 55px rgba(11,18,32,.10);
      --shadow2: 0 10px 28px rgba(11,18,32,.08);

      --r:14px;
      --r2:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 15% -10%, rgba(37,99,235,.14), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(22,163,74,.08), transparent 55%),
        var(--bg);
      min-height:100vh;
    }

    .wrap{
      max-width:860px;  /* single column feel */
      margin:0 auto;
      padding:28px 16px 72px;
    }

    /* header */
    .hdr{
      display:flex;
      justify-content:space-between;
      gap:14px;
      align-items:flex-start;
      margin-bottom:14px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      font-weight:900;
      letter-spacing:.2px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .mark{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg, rgba(37,99,235,1), rgba(29,78,216,.82));
      box-shadow: 0 14px 30px rgba(37,99,235,.18);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .brand p{
      margin:8px 0 0;
      color:var(--muted);
      font-size:13.5px;
      line-height:1.55;
      max-width:720px;
    }

    /* card */
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--r2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHd{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .cardHd .t{font-weight:900}
    .cardHd .s{font-size:12px;color:var(--muted)}
    .cardBd{padding:16px}

    /* address block */
    .addrRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    @media (max-width:720px){ .addrRow{grid-template-columns:1fr} }

    .input{
      width:100%;
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:13px 14px;
      font-size:14px;
      font-family:var(--mono);
      outline:none;
    }

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      border-radius:12px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      transition:transform .06s ease, box-shadow .15s ease, border-color .15s ease, opacity .15s ease;
    }
    .btn:hover{box-shadow:var(--shadow2);border-color:#d7deea}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(180deg, var(--primary), var(--primary2));
      color:#fff;border-color:transparent;
      box-shadow: 0 18px 38px rgba(37,99,235,.18);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}

    .metaRow{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    .status{
      display:flex;align-items:center;gap:10px;
      font-size:13px;color:var(--muted);
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#cbd5e1}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    /* progress */
    .progressWrap{
      margin-top:12px;
      border:1px solid var(--border);
      background:#fbfcff;
      border-radius:12px;
      padding:10px 12px;
      display:none;
    }
    .bar{
      height:8px;
      background:#eef2ff;
      border-radius:999px;
      overflow:hidden;
      border:1px solid #e7ebf3;
    }
    .bar > div{
      height:100%;
      width:35%;
      background:linear-gradient(90deg, rgba(37,99,235,.75), rgba(37,99,235,1));
      border-radius:999px;
      animation: indet 1.2s ease-in-out infinite;
    }
    @keyframes indet{
      0%{transform:translateX(-120%)}
      50%{transform:translateX(40%)}
      100%{transform:translateX(220%)}
    }
    .progressText{
      margin-top:8px;
      font-size:12px;color:var(--muted);
      line-height:1.45;
    }

    /* score summary */
    .scoreRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:14px;
      flex-wrap:wrap;
      border:1px solid var(--border);
      background:#fff;
      border-radius:16px;
      padding:14px;
    }
    .scoreLeft{display:flex;gap:12px;align-items:center}
    .scoreBox{
      width:74px;height:74px;border-radius:16px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, #fff, #f3f6ff);
      display:grid;place-items:center;
    }
    .scoreBox .n{font-size:22px;font-weight:900}
    .scoreBox .sub{font-size:11px;color:var(--muted)}
    .scoreTxt .title{font-weight:900;font-size:16px;margin:0}
    .scoreTxt .desc{margin-top:4px;color:var(--muted);font-size:13px;line-height:1.45;max-width:560px}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      font-size:12px;font-weight:900;color:var(--muted);
      white-space:nowrap;
    }
    .badge.good{border-color:#bbf7d0;background:#f0fdf4;color:#166534}
    .badge.warn{border-color:#fde68a;background:#fffbeb;color:#92400e}
    .badge.bad{border-color:#fecaca;background:#fef2f2;color:#991b1b}

    /* issues list (top) */
    .sectionTitle{
      margin:16px 0 10px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .sectionTitle h3{margin:0;font-size:14px}
    .sectionTitle .meta{font-size:12px;color:var(--muted)}

    .issues{display:flex;flex-direction:column;gap:10px}
    .issue{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:start;
    }
    .issue .what{font-weight:900}
    .issue .impact{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.5}
    .issue .fix{margin-top:8px;font-size:13px;line-height:1.5}
    .pill{
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-family:var(--mono);
      font-size:12px;font-weight:900;
      height:fit-content;
      background:#f8fafc;color:var(--muted);
      white-space:nowrap;
    }
    .pill.bad{border-color:#fecaca;background:#fef2f2;color:#991b1b}
    .pill.warn{border-color:#fde68a;background:#fffbeb;color:#92400e}
    .pill.good{border-color:#bbf7d0;background:#f0fdf4;color:#166534}

    /* accordion */
    .acc{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .acc summary{
      cursor:pointer;
      list-style:none;
      padding:12px 14px;
      font-weight:900;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .acc summary::-webkit-details-marker{display:none}
    .acc summary .right{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .acc summary:after{
      content:"▾";
      color:var(--muted);
      font-weight:900;
    }
    .acc:not([open]) summary:after{content:"▸"}
    .acc .body{
      padding:0 14px 14px;
      border-top:1px solid var(--border);
    }

    .code{
      margin-top:10px;
      white-space:pre-wrap;
      font-family:var(--mono);
      background:#0b1220;
      color:#e5e7eb;
      border:1px solid #111827;
      border-radius:12px;
      padding:12px;
      overflow:auto;
      max-height:420px;
    }

    /* checks table */
    .checks{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
    }
    .checksRow{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:0;
      border-top:1px solid var(--border);
      background:#fff;
    }
    .checksRow:first-child{border-top:none}
    .checksCell{
      padding:10px 12px;
      font-size:13px;
      line-height:1.4;
    }
    .checksCell.k{
      color:var(--muted);
      background:#fbfcff;
      border-right:1px solid var(--border);
      font-weight:800;
    }
    .checksCell.v{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .miniTag{
      display:inline-flex;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      white-space:nowrap;
    }
    .miniTag.good{border-color:#bbf7d0;background:#f0fdf4;color:#166534}
    .miniTag.bad{border-color:#fecaca;background:#fef2f2;color:#991b1b}
    .miniTag.neutral{border-color:#e2e8f0;background:#f8fafc;color:#475569}

    /* dnsbl lists */
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .listBox{
      margin-top:10px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:12px;
    }
    .listBox h4{margin:0 0 8px;font-size:13px}
    .listBox ul{margin:0;padding-left:18px}
    .listBox li{margin:4px 0;font-family:var(--mono);font-size:12px;color:var(--muted)}
    .empty{color:var(--muted);font-size:12px}

    .hidden{display:none !important}
  </style>
</head>
<body>
<div class="wrap">

  <div class="hdr">
    <div class="brand">
      <h1>
        <span class="mark" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M4 8.5l8 5 8-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5 7h14a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        Mail Tester
      </h1>
      <p>
        Step 1: Send your email to the generated address. Step 2: Click <b>Check score</b> to get a deliverability report.
      </p>
    </div>
  </div>

  <!-- ADDRESS / WAITING -->
  <div class="card">
    <div class="cardHd">
      <div class="t">Test address</div>
      <div class="s" id="reportStatus">Status: —</div>
    </div>
    <div class="cardBd">
      <div class="addrRow">
        <input id="toAddress" class="input" readonly placeholder="Generating…"/>
        <div class="btnRow">
          <button id="btnCopy" class="btn">Copy</button>
          <button id="btnCheck" class="btn primary" disabled>Check score</button>
        </div>
      </div>

      <div class="metaRow">
        <div class="status">
          <span id="dot" class="dot warn"></span>
          <span id="statusText">Generating address…</span>
        </div>
        <div class="btnRow">
          <button id="btnRegen" class="btn">Regenerate</button>
        </div>
      </div>

      <div id="progressWrap" class="progressWrap">
        <div class="bar"><div></div></div>
        <div class="progressText" id="progressText">
          Waiting for your email to arrive and be analyzed…
        </div>
      </div>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="results" class="card hidden" style="margin-top:14px">
    <div class="cardHd">
      <div class="t">Deliverability report</div>
      <div class="s">Actionable fixes first.</div>
    </div>
    <div class="cardBd">

      <div class="scoreRow">
        <div class="scoreLeft">
          <div class="scoreBox">
            <div style="text-align:center">
              <div class="n" id="scoreNum">-</div>
              <div class="sub">/ 10</div>
            </div>
          </div>
          <div class="scoreTxt">
            <div class="title" id="gradeText">—</div>
            <div class="desc" id="summaryText">—</div>
          </div>
        </div>
        <div class="badges">
          <span class="badge" id="badgeStatus">status</span>
          <span class="badge" id="badgeSA">SpamAssassin</span>
        </div>
      </div>

      <div class="sectionTitle">
        <h3>Issues</h3>
        <div class="meta" id="issueCount">0</div>
      </div>
      <div id="issues" class="issues"></div>

      <!-- Accordion stack: SA -> Checks -> DNSBL -->
      <details class="acc" id="accSA">
        <summary>
          <span>SpamAssassin</span>
          <span class="right" id="saMeta">—</span>
        </summary>
        <div class="body">
          <div class="code" id="saReport">(no report)</div>
        </div>
      </details>

      <details class="acc" id="accChecks">
        <summary>
          <span>Authentication & header checks</span>
          <span class="right">SPF / DKIM / DMARC / rDNS</span>
        </summary>
        <div class="body">
          <div class="checks" id="checksTable"></div>
        </div>
      </details>

      <details class="acc" id="accDNSBL">
        <summary>
          <span>DNSBL / blocklists</span>
          <span class="right" id="dnsblMeta">—</span>
        </summary>
        <div class="body">
          <div id="dnsblBlock" class="empty">(no data)</div>
        </div>
      </details>

    </div>
  </div>

</div>

<script>
  // API base (dev-only): set localStorage key "mt_api_base" if you need.
  // Example: localStorage.setItem("mt_api_base","http://localhost:8000");
  let API_BASE = localStorage.getItem("mt_api_base") || `${location.origin}/api`;

  let currentTo = null;
  let pollTimer = null;

  const $ = (id) => document.getElementById(id);
  const safeJson = (o) => { try { return JSON.stringify(o, null, 2); } catch { return String(o); } };

  function setStatus(text, kind="warn"){
    $("statusText").textContent = text;
    $("dot").className = "dot " + (kind || "");
  }

  function showProgress(show, text){
    const w = $("progressWrap");
    w.style.display = show ? "block" : "none";
    if(text) $("progressText").textContent = text;
  }

  function kindFromStatus(st){
    if(st === "analyzed") return "good";
    if(st === "processing" || st === "pending") return "warn";
    if(st === "error" || st === "expired") return "bad";
    return "warn";
  }

  function badge(el, kind, text){
    el.classList.remove("good","warn","bad");
    if(kind) el.classList.add(kind);
    el.textContent = text;
  }

  // ---------- API ----------
  async function apiGenerate(){
    const res = await fetch(`${API_BASE}/generate`, { method:"POST" });
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(`Generate failed: ${res.status}`);

    const addr =
      data.to_address || data.toAddress || data.address || data.email || data.test_address ||
      (typeof data.result === "string" ? data.result : null) ||
      data.result?.to_address || data.result?.address || data.result?.email;

    if(!addr) throw new Error("Generate response did not include address. Raw: " + safeJson(data));
    return addr;
  }

  async function apiResult(toAddr){
    const encoded = encodeURIComponent(toAddr);
    const res = await fetch(`${API_BASE}/result/${encoded}`);
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(`Result failed: ${res.status}`);
    return data;
  }

  // ---------- FIXES / Issues ----------
  function fixSuggestion(issueText){
    const t = (issueText || "").toLowerCase();
    if(t.includes("list-unsubscribe")) return "Add a List-Unsubscribe header (mailto and/or https) for bulk mail.";
    if(t.includes("spf")) return "Publish an SPF record (v=spf1 ...) authorizing your sender.";
    if(t.includes("dkim")) return "Enable DKIM signing and publish the selector TXT record.";
    if(t.includes("dmarc")) return "Add a DMARC policy at _dmarc (start with p=none, then enforce).";
    if(t.includes("reverse") || t.includes("rdns")) return "Set PTR / reverse DNS to match your sending identity.";
    if(t.includes("blacklist") || t.includes("dnsbl")) return "Investigate the listing, fix root cause, then request delisting.";
    if(t.includes("message-id")) return "Ensure a valid Message-ID header is present.";
    if(t.includes("date header")) return "Ensure a valid Date header is present (RFC 5322).";
    return "Review headers and authentication for this item.";
  }

  function impactBucket(value){
    const v = Number(value || 0);
    if(v >= 2) return { cls:"bad", label:"High" };
    if(v >= 0.8) return { cls:"warn", label:"Medium" };
    return { cls:"good", label:"Low" };
  }

  function renderIssues(result){
    const host = $("issues");
    host.innerHTML = "";

    const items = Array.isArray(result.items) ? result.items : [];
    $("issueCount").textContent = `${items.length} issue(s)`;

    if(items.length === 0){
      const ok = document.createElement("div");
      ok.className = "issue";
      ok.innerHTML = `
        <div>
          <div class="what">No issues detected</div>
          <div class="impact">Your message looks good for deliverability.</div>
        </div>
        <div class="pill good">OK</div>
      `;
      host.appendChild(ok);
      return;
    }

    const sorted = items.slice().sort((a,b)=>(Number(b.value||0)-Number(a.value||0)));
    for(const it of sorted){
      const what = it.text || it.title || "Issue";
      const val = Number(it.value ?? 0);
      const imp = impactBucket(val);
      const fix = fixSuggestion(what);

      const el = document.createElement("div");
      el.className = "issue";
      el.innerHTML = `
        <div>
          <div class="what">${what}</div>
          <div class="impact"><b>Impact:</b> ${imp.label} • <span class="pill ${imp.cls}">-${val.toFixed(1)}</span></div>
          <div class="fix"><b>Fix:</b> ${fix}</div>
        </div>
        <div class="pill ${imp.cls}">-${val.toFixed(1)}</div>
      `;
      host.appendChild(el);
    }
  }

  // ---------- Checks ----------
  function verdictFromObj(obj){
    if(obj == null) return { kind:"neutral", text:"Unknown" };
    if(typeof obj === "boolean") return obj ? {kind:"good",text:"Pass"} : {kind:"bad",text:"Fail"};
    if(typeof obj === "string"){
      const t = obj.toLowerCase().trim();
      if(["pass","ok","true","exists","found","present","yes"].includes(t)) return {kind:"good",text:"Pass"};
      if(["fail","false","missing","not_found","no"].includes(t)) return {kind:"bad",text:"Fail"};
      if(["skipped"].includes(t)) return {kind:"neutral",text:"Skipped"};
      return {kind:"neutral",text:obj};
    }
    if(obj.skipped === true) return {kind:"neutral",text:"Skipped"};
    const candidates = [obj.pass,obj.ok,obj.success,obj.exists,obj.found];
    for(const c of candidates){
      if(c === true || String(c).toLowerCase()==="true") return {kind:"good",text:"Pass"};
      if(c === false || String(c).toLowerCase()==="false") return {kind:"bad",text:"Fail"};
    }
    return {kind:"neutral",text:"Unknown"};
  }

  function miniTag(kind, text){
    const s = document.createElement("span");
    s.className = "miniTag " + (kind || "neutral");
    s.textContent = text;
    return s;
  }

  function addCheckRow(host, key, label, verdict){
    const row = document.createElement("div");
    row.className = "checksRow";
    const k = document.createElement("div");
    k.className = "checksCell k";
    k.textContent = label;
    const v = document.createElement("div");
    v.className = "checksCell v";
    const left = document.createElement("div");
    left.textContent = key;
    left.style.color = "var(--muted)";
    left.style.fontSize = "12px";
    v.appendChild(left);
    v.appendChild(miniTag(verdict.kind, verdict.text));
    row.appendChild(k);
    row.appendChild(v);
    host.appendChild(row);
  }

  function renderChecks(result){
    const checks = result.checks || {};
    const host = $("checksTable");
    host.innerHTML = "";

    addCheckRow(host, "TXT record v=spf1", "SPF", verdictFromObj(checks.spf));
    addCheckRow(host, "DKIM signature + selector", "DKIM", verdictFromObj(checks.dkim));
    addCheckRow(host, "_dmarc policy record", "DMARC", verdictFromObj(checks.dmarc));
    addCheckRow(host, "PTR / reverse DNS", "rDNS", verdictFromObj(checks.rdns));

    const bl = checks.blacklists || checks.dnsbl || null;
    addCheckRow(host, "IP reputation on blocklists", "DNSBL", verdictFromObj(bl));
  }

  // ---------- DNSBL details ----------
  function tag(kind, text){
    const s = document.createElement("span");
    s.className = "badge " + (kind || "");
    s.textContent = text;
    return s;
  }

  function renderDNSBL(result){
    const checks = result.checks || {};
    const bl = checks.blacklists || checks.dnsbl || null;
    const dnsHost = $("dnsblBlock");
    dnsHost.innerHTML = "";

    const res = bl?.results || null;
    if(!res || typeof res !== "object" || Object.keys(res).length === 0){
      dnsHost.textContent = "(no DNSBL details)";
      $("dnsblMeta").textContent = "—";
      return;
    }

    const listed=[], notListed=[], timeout=[], err=[];
    for(const [name, st] of Object.entries(res)){
      if(st === "listed") listed.push(name);
      else if(st === "not_listed") notListed.push(name);
      else if(st === "timeout") timeout.push(name);
      else err.push(name);
    }

    $("dnsblMeta").textContent = `Listed: ${listed.length}`;

    const chips = document.createElement("div");
    chips.className = "chips";
    chips.appendChild(tag(listed.length ? "bad":"good", `Listed: ${listed.length}`));
    chips.appendChild(tag("good", `Not listed: ${notListed.length}`));
    chips.appendChild(tag(timeout.length ? "warn":"", `Timeout: ${timeout.length}`));
    chips.appendChild(tag(err.length ? "warn":"", `Error: ${err.length}`));
    dnsHost.appendChild(chips);

    function listBox(title, arr){
      const box = document.createElement("div");
      box.className = "listBox";
      box.innerHTML = `<h4>${title}</h4>`;
      if(arr.length === 0){
        const e = document.createElement("div");
        e.className = "empty";
        e.textContent = "(none)";
        box.appendChild(e);
      } else {
        const ul = document.createElement("ul");
        arr.forEach(x => { const li=document.createElement("li"); li.textContent=x; ul.appendChild(li); });
        box.appendChild(ul);
      }
      return box;
    }

    dnsHost.appendChild(listBox("Listed on", listed));
    dnsHost.appendChild(listBox("Timeout", timeout));
    dnsHost.appendChild(listBox("Other errors", err));
  }

  // ---------- SpamAssassin ----------
  function renderSpamAssassin(result){
    const sa = result.spamassassin || {};
    const report = (sa.report || "").trim();
    $("saReport").textContent = report ? report : "(no report)";

    if(sa.score != null && sa.threshold != null){
      $("saMeta").textContent = `Score: ${sa.score} / ${sa.threshold}`;
    } else if(sa.error){
      $("saMeta").textContent = `Error: ${sa.error}`;
    } else {
      $("saMeta").textContent = "—";
    }

    // badge
    if(sa && sa.error){
      badge($("badgeSA"), "warn", "SpamAssassin: error");
    } else if(sa && sa.report){
      const m = sa.report.match(/Spam:\s*(True|False)\s*;\s*([-\d.]+)\s*\/\s*([-\d.]+)/i);
      if(m){
        const isSpam = m[1].toLowerCase()==="true";
        badge($("badgeSA"), isSpam ? "bad":"good", `SpamAssassin: ${m[2]} / ${m[3]}`);
      } else {
        badge($("badgeSA"), "good", "SpamAssassin: OK");
      }
    } else {
      badge($("badgeSA"), "", "SpamAssassin: n/a");
    }
  }

  // ---------- Top summary ----------
  function renderTopSummary(status, result){
    $("reportStatus").textContent = `Status: ${status}`;
    const score = (typeof result.score === "number") ? result.score : Number(result.score || 0);
    $("scoreNum").textContent = isFinite(score) ? score.toFixed(1) : "-";
    $("gradeText").textContent = result.title || "—";

    const issueCount = Array.isArray(result.items) ? result.items.length : 0;
    const best = score >= 9.5 ? "Excellent" : (score >= 8 ? "Good" : (score >= 6 ? "Needs work" : "Poor"));
    $("summaryText").textContent =
      issueCount === 0
        ? `${best}. No major deliverability issues detected.`
        : `${best}. Found ${issueCount} issue(s). Fix the items below to improve inbox placement.`;

    badge($("badgeStatus"), kindFromStatus(status), status);
  }

  function renderAll(payload){
    $("results").classList.remove("hidden");

    const status = payload?.status || "unknown";
    const result = payload?.result || {};

    renderTopSummary(status, result);
    renderIssues(result);
    renderSpamAssassin(result);
    renderChecks(result);
    renderDNSBL(result);

    // default open: Issues already visible; open SA if it exists
    if((result.spamassassin?.report || "").trim()){
      $("accSA").open = true;
    }
    // open checks if any are known
    $("accChecks").open = true;
  }

  // ---------- Polling ----------
  async function refreshOnce(){
    const payload = await apiResult(currentTo);
    const st = payload?.status || "unknown";

    $("reportStatus").textContent = `Status: ${st}`;

    if(st === "analyzed" || st === "error" || st === "expired"){
      showProgress(false);
      stopPolling();

      if(st === "analyzed"){
        setStatus("Analyzed. Showing results.", "good");
        renderAll(payload);
      } else {
        setStatus(`Finished with status: ${st}`, "bad");
        // show results if present
        if(payload?.result) renderAll(payload);
      }

      $("btnCheck").disabled = false;
      $("btnCheck").textContent = "Check score";
      return;
    }

    setStatus(`Waiting… (${st})`, "warn");
    showProgress(true, "Waiting for your email to arrive and be analyzed…");
  }

  function startPolling(){
    stopPolling();
    showProgress(true, "Waiting for your email to arrive and be analyzed…");
    pollTimer = setInterval(async () => {
      try { await refreshOnce(); }
      catch(e){
        stopPolling();
        showProgress(false);
        setStatus("API error: " + (e?.message || e), "bad");
        $("btnCheck").disabled = false;
        $("btnCheck").textContent = "Check score";
      }
    }, 2500);
  }

  function stopPolling(){
    if(pollTimer){
      clearInterval(pollTimer);
      pollTimer = null;
    }
  }

  // ---------- Actions ----------
  async function generateAddress(){
    $("toAddress").value = "";
    $("btnCheck").disabled = true;
    currentTo = null;

    setStatus("Generating address…", "warn");
    showProgress(false);

    const addr = await apiGenerate();
    currentTo = addr;
    $("toAddress").value = addr;

    setStatus("Address ready. Send your email, then click Check score.", "good");
    $("btnCheck").disabled = false;
  }

  $("btnCopy").addEventListener("click", async () => {
    const v = $("toAddress").value;
    if(!v) return;
    try{
      await navigator.clipboard.writeText(v);
      setStatus("Copied to clipboard.", "good");
      setTimeout(()=> setStatus("Address ready. Send your email, then click Check score.", "good"), 1200);
    } catch {
      $("toAddress").select();
      document.execCommand("copy");
      setStatus("Copied.", "good");
      setTimeout(()=> setStatus("Address ready. Send your email, then click Check score.", "good"), 1200);
    }
  });

  $("btnCheck").addEventListener("click", async () => {
    if(!currentTo) return;
    try{
      $("btnCheck").disabled = true;
      $("btnCheck").textContent = "Checking…";
      setStatus("Checking for results…", "warn");
      showProgress(true, "Checking status… If the message is not analyzed yet, we will keep polling.");
      await refreshOnce();
      startPolling();
    } catch(e){
      showProgress(false);
      setStatus("Error: " + (e?.message || e), "bad");
      $("btnCheck").disabled = false;
      $("btnCheck").textContent = "Check score";
    }
  });

  $("btnRegen").addEventListener("click", async () => {
    stopPolling();
    showProgress(false);
    $("results").classList.add("hidden");
    try{
      await generateAddress();
    } catch(e){
      setStatus("Error: " + (e?.message || e), "bad");
    }
  });

  // Init
  (function init(){
    generateAddress().catch(e => {
      setStatus("Error: " + (e?.message || e), "bad");
    });
  })();
</script>
</body>
</html>
